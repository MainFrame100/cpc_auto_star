## 1. Общее Описание

**Цель:** Разработка веб-приложения (SaaS) MVP для специалистов по контекстной рекламе Яндекс.Директ. MVP фокусируется на предоставлении еженедельной статистики (включая конверсии по указанным пользователем целям) из **боевого API** с возможностью просмотра в улучшенном UI, выгрузки в CSV и базовой оптимизации (блокировка площадок). Сбор данных инициируется вручную.

**Технологический стек:**
*   **Backend:** Python 3.x, Flask, Flask-Login, Flask-SQLAlchemy, SQLAlchemy
*   **Frontend:** HTML (Jinja2), CSS, JavaScript (базовый)
*   **База данных:** **SQLite (Текущий)** -> **PostgreSQL (Планируется в Вехе 5)**
*   **HTTP Запросы:** Requests
*   **Парсинг/Генерация CSV:** Модуль `csv`, `io`
*   **Конфигурация:** python-dotenv

**Окружение Разработки:**
*   **ОС:** Windows 10/11
*   **Python:** Версия 3.x
*   **Виртуальное окружение:** `venv`
*   **Менеджер пакетов:** `pip`

**Структура проекта (Актуальная):**


C:\python\cpc_auto_star
├── venv
├── instance/
│ └── tokens.db # Временно SQLite
├── app/ # Основная папка приложения
│ ├── init.py # Инициализация приложения, регистрация Blueprints
│ ├── models.py # Модель SQLAlchemy (Token)
│ ├── config.py # Конфигурация приложения
│ ├── main/ # Blueprint для основных маршрутов (/) - ДОБАВЛЕНО
│ │ ├── init.py # Инициализация Blueprint 'main'
│ │ └── routes.py # Роут '/' (перенаправление на вход/отчеты)
│ ├── auth/ # Blueprint 'auth' (аутентификация)
│ │ ├── init.py
│ │ ├── routes.py # Роуты /login, /callback, /logout
│ │ └── utils.py # Функции работы с токенами (get_valid_token etc.)
│ ├── reports/ # Blueprint 'reports' (отчеты и действия)
│ │ ├── init.py
│ │ ├── routes.py # Роуты /campaigns, /campaign/<id>/view, /download_csv etc.
│ │ └── utils.py # Функции для API Reports и API Управления
│ └── templates/ # Шаблоны Jinja2
│ ├── base.html
│ ├── main/ # Шаблоны для main (если нужны)
│ ├── auth/ # Шаблоны для auth (например, страница входа)
│ └── reports/ # Шаблоны для reports (campaign_list.html, campaign_detail.html)
├── static/ # Статические файлы
│ ├── css/ (style.css)
│ └── js/ (main.js)
├── utils/ # Утилиты
│ └── create_test_campaigns.py
├── .env # Переменные окружения (Ключи API, SECRET_KEY, DB_URI)
├── .gitignore
├── requirements.txt
├── run.py # Точка входа для запуска
├── BUSINESS_LOGIC.md # Документ с бизнес-логикой
├── UI_DOCUMENTATION.md # Документация по интерфейсу
└── PROJECT_README.md # Этот файл (рабочий лог)

## 2. Текущий Статус (Что уже сделано - Завершение Вехи 4 и Старт Вехи 5)

*   [x] Настроена среда разработки.
*   [x] Реализован полный цикл Яндекс OAuth с хранением токенов в БД (SQLite) и автообновлением.
*   [x] Реализовано управление сессиями пользователей через Flask-Login (с сохранением между перезапусками).
*   [x] Код реорганизован с использованием Flask Blueprints (`main`, `auth`, `reports`).
*   [x] Реализован механизм сбора еженедельной статистики из API Reports (по основным срезам, **без конверсий**) и сохранения в БД SQLite.
*   [x] Реализован **ручной запуск** сбора/обновления данных.
*   [x] Создана утилита для генерации тестовых кампаний в Песочнице.
*   [x] Проведен **UX/UI анализ** и **интегрированы** артефакты нового дизайна (CSS, базовый JS, шаблоны Jinja2 с табами).
*   [x] Реализован просмотр собранных данных из БД с **табами** и **серверной пагинацией**.
*   [x] **Получен полный доступ к боевому API Яндекс.Директ.**
*   [x] Приложение переключено на работу с **боевым API** и протестировано получение списка кампаний.
*   [ ] База данных переведена на **PostgreSQL**.
*   [ ] Реализован сбор и отображение данных по **конверсиям** (с ручным вводом ID целей).
*   [ ] Реализована **серверная сортировка** таблиц (площадки, запросы).
*   [ ] Реализована **блокировка площадок** (UI + API).
*   [ ] Реализована функция **скачивания CSV**.
*   [ ] Убраны тестовые ограничения сбора данных.

## 3. ЗАДАЧА ДЛЯ CURSOR - Веха 5: MVP в Production

**Цель:** Перевести приложение на работу с боевым API Яндекс.Директ, реализовать сбор и отображение данных по конверсиям (на основе ID целей, указанных пользователем), завершить функцию скачивания CSV и реализовать блокировку площадок. Подготовить приложение к работе с реальными данными на PostgreSQL.

**Контекст для Cursor:** (Без изменений)
*   Используется Flask, SQLAlchemy, Jinja2, Flask-Login.
*   Получен доступ к боевому API.
*   Текущая БД - SQLite, планируется переход на PostgreSQL.
*   Интерфейс использует табы и пагинацию.
*   Документация (`BUSINESS_LOGIC.md`, `UI_DOCUMENTATION.md`) существует.
*   Сбор конверсий будет основан на ID целей, указанных пользователем (механизм ввода пока не реализуем, предполагаем, что ID целей для кампании известны).

**Разбивка на подзадачи (Приоритеты согласно предыдущему обсуждению):**

**Подзадача 5.1: Переход на Боевое API и Тестирование - ЗАВЕРШЕНО**

*   **Действия:**
    1.  Настроить `app/config.py` и `.env` для работы с боевыми URL API и OAuth-токеном Production. Обеспечить возможность переключения конфигурации (Prod/Sandbox). - **Сделано**
    2.  Протестировать аутентификацию и базовый сбор/отображение данных (без конверсий) на **боевом API**. - **Сделано** (аутентификация и получение списка кампаний проверены)
*   **Проверка:** Приложение подключается к боевому API, собирает и отображает статистику (без конверсий). - **Проверено** (подключение, аутентификация, список кампаний)

**Подзадача 5.2: Миграция на PostgreSQL**

*   **Действия:**
    1.  Установить `psycopg2-binary`.
    2.  Настроить подключение к PostgreSQL в `app/config.py` и `.env`.
    3.  Создать таблицы в PostgreSQL (`db.create_all()` или через Flask-Migrate).
    4.  Протестировать базовые операции (запись/чтение токенов, статистики) с PostgreSQL.
*   **Проверка:** Приложение работает с PostgreSQL.

**Подзадача 5.3: Реализация Сбора и Отображения Конверсий (Ручной ввод ID)**

*   **Действия:**
    1.  Определить/захардкодить список ID целей Метрики для отслеживания.
    2.  Модифицировать запросы к API Reports для передачи `Goals` и запроса полей конверсий.
    3.  Адаптировать модели БД (PostgreSQL) и логику записи.
    4.  Адаптировать роут `view_campaign_detail` и шаблон `campaign_detail.html` для расчета и отображения CPA, CR.
*   **Проверка:** Отображаются данные по конверсиям для указанных целей.

**Подзадача 5.4: Реализация Серверной Сортировки (Площадки и Запросы)**

*   **Действия:**
    1.  Модифицировать роут `view_campaign_detail` для приема параметров сортировки (`sort_by`, `sort_order`) из `request.args`.
    2.  Применять `.order_by()` к запросам SQLAlchemy для таблиц площадок и запросов перед пагинацией.
    3.  Обновить шаблон `campaign_detail.html`, добавив ссылки в заголовки таблиц для передачи параметров сортировки. Добавить визуальную индикацию активной сортировки.
*   **Проверка:** Таблицы площадок и запросов корректно сортируются по клику на заголовки.

**Подзадача 5.5: Реализация Блокировки Площадок**

*   **Действия:**
    1.  Добавить форму с чекбоксами и кнопкой в таб "Площадки", добавить JS `confirm()`.
    2.  Реализовать backend-функцию `block_placements_on_campaign` (вызов API `set`, обработка ошибок). **Уточнить API: `Campaigns.set` или `AdGroups.set`?**
    3.  Реализовать POST-роут, использовать `flash`.
*   **Проверка:** Выбранные площадки блокируются в Директе, пользователь видит сообщение.

**Подзадача 5.6: Реализация Скачивания CSV**

*   **Действия:**
    1.  Добавить форму выбора срезов и кнопку "Скачать CSV".
    2.  Реализовать роут `reports.download_csv`.
    3.  Реализовать логику выборки данных (включая конверсии) из PostgreSQL по выбранным срезам за 4 недели.
    4.  Реализовать расчет на лету CTR, CPC, CR, CPA для CSV.
    5.  Сформировать и отдать CSV-файл.
*   **Проверка:** Скачивается корректный CSV-файл.

**Подзадача 5.7: Финальная Очистка**

*   **Действия:**
    1.  Убрать тестовые ограничения сбора данных (`[:1]`, `n_weeks=1` -> `n_weeks=4`).
    2.  Ревью кода, комментарии/docstrings.
    3.  Финальное тестирование MVP.
*   **Проверка:** MVP готов к использованию первыми лояльными пользователями.

## 4. Логика Работы с Документацией (Процесс)

*   **После Завершения Вехи 5:**
    *   Cursor генерирует детальное "Что мы сделали".
    *   Обновляем `PROJECT_README.md`: финализируем статус Вехи 5, планируем Веху 6.
    *   Обновляем `BUSINESS_LOGIC.md`.
    *   Обновляем `UI_DOCUMENTATION.md`.
    *   Обновляем `README.md` (основной) с инструкциями для MVP.

## 5. Ограничения Песочницы и Функционал для Боевого API

*   **Конверсии:** Реализованы с ручным вводом ID целей. Автоматическое получение ID – в бэклоге.
*   **Модели атрибуции:** Не поддерживаются в MVP.

## 6. Следующие Шаги (После Вехи 5 - MVP)**

*   [ ] **Веха 6: Автоматизация, Действия, Улучшения:** Автосбор (`cron`/Celery), Минусация, Получение ID Целей, Улучшения UX (фильтры), Оптимизация (PostgreSQL, фоновые задачи), Шифрование.
*   [ ] **Веха 7: Интеграция AI.**
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
IGNORE_WHEN_COPYING_END