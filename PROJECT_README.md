# Проект: CPC Auto Helper (Стартовый этап MVP)

## 1. Общее Описание

**Цель:** Разработка веб-приложения (SaaS) для помощи специалистам по контекстной рекламе Яндекс.Директ, автоматизирующего сбор и предоставляющего инструменты для анализа еженедельной статистики кампаний.

**Технологический стек:**
*   **Backend:** Python 3.x, Flask
*   **Структура:** Flask Blueprints
*   **Работа с БД:** Flask-SQLAlchemy (ORM), SQLAlchemy
*   **База данных:** SQLite (файл `tokens.db`)
*   **HTTP Запросы:** Requests
*   **Парсинг/Генерация CSV:** Модуль `csv` Python, `io`
*   **Конфигурация:** python-dotenv
*   **Frontend:** HTML (через Jinja2), CSS, базовый JavaScript (без фреймворков).

**Окружение Разработки:**
*   **ОС:** Windows 10/11
*   **Python:** Версия 3.x (установлен)
*   **Виртуальное окружение:** Используется `venv`
*   **Менеджер пакетов:** `pip`

**Структура проекта:**
```
C:\python\cpc_auto_star\
├── venv\
├── instance/
│   └── tokens.db
├── app/
│   ├── __init__.py
│   ├── models.py
│   ├── auth/
│   ├── reports/
│   ├── templates/ # Используется Jinja2
│   │   ├── base.html
│   │   ├── auth/
│   │   └── reports/
│   │       ├── campaign_list.html # Обновлен UI
│   │       └── campaign_detail.html # Обновлен UI
│   └── static/ # Папка для статики
│       ├── css/
│       │   └── style.css # Обновлен UI
│       └── js/
│           └── main.js # Добавлен JS для UI
├── utils/
│   └── create_test_campaigns.py
├── .env
├── .gitignore
├── requirements.txt
├── run.py
├── BUSINESS_LOGIC.md # Документ с бизнес-логикой
├── UI_DOCUMENTATION.md # Документация по новому UI - **НОВОЕ**
└── PROJECT_README.md # Этот файл
```

## 2. Текущий Статус (Что уже сделано)

*   [x] Настроена среда разработки.
*   [x] Реализован полный цикл Яндекс OAuth с хранением токенов в БД и автообновлением.
*   [x] Код реорганизован с использованием Flask Blueprints (`auth`, `reports`).
*   [x] Реализован вывод списка кампаний пользователя.
*   [x] Реализован механизм сбора еженедельной статистики из API Reports и сохранения в локальную БД (инициируется вручную).
*   [x] Реализовано отображение собранных еженедельных данных на странице детализации кампании (из БД).
*   [x] Создана утилита для генерации тестовых кампаний.
*   [x] Создан документ `BUSINESS_LOGIC.md`.
*   [x] **Интегрированы базовые файлы нового UI:**
    *   [x] Заменен CSS (`static/css/style.css`).
    *   [x] Добавлен JS (`static/js/main.js`).
    *   [x] Обновлены шаблоны `campaign_list.html` и `campaign_detail.html`.
    *   [x] Создан документ `UI_DOCUMENTATION.md`, описывающий новый интерфейс.
*   [ ] Адаптирована логика Flask (роуты, передача данных) для корректной работы с новыми шаблонами и JS.
*   [ ] Реализована серверная пагинация для таблиц.
*   [ ] Реализована функция **скачивания CSV** по выбранным срезам из локальной БД.

## 3. ЗАДАЧА ДЛЯ CURSOR - Шаг 6: Адаптация Backend к Новому UI и Реализация Пагинации

**Цель:** Обеспечить корректную работу нового пользовательского интерфейса (интегрированного на предыдущем шаге) с существующей backend-логикой Flask. Адаптировать передачу данных в обновленные шаблоны Jinja2, реализовать серверную пагинацию для больших таблиц и убедиться в работоспособности базового JS.

**Контекст:**
*   Новый UI описан в файле `UI_DOCUMENTATION.md`.
*   Основные изменения коснулись шаблонов `campaign_list.html` и `campaign_detail.html`, а также CSS и JS.
*   Новый UI предполагает использование вкладок (tabs) для срезов данных, карточек для метрик, улучшенных таблиц с возможностью поиска, сортировки (JS) и пагинации (требует backend).

**Требования к реализации:**

**Подзадача 6.1: Адаптация Роута и Шаблона Списка Кампаний (`/reports/campaigns`)**

*   **Роут (`app/reports/routes.py`):**
    *   Убедиться, что роут передает в шаблон `campaign_list.html` список кампаний в формате, ожидаемом новым шаблоном (проверить циклы и переменные в `campaign_list.html`).
    *   Возможно, потребуется передать дополнительные данные, если новый шаблон их ожидает.
*   **Шаблон (`app/templates/reports/campaign_list.html`):**
    *   Проверить корректность отображения списка кампаний с новыми стилями и структурой.

**Подзадача 6.2: Адаптация Роута и Шаблона Детализации Кампании (`/reports/campaign/<id>/view`)**

*   **Роут (`app/reports/routes.py`):**
    *   **Структура данных:** Пересмотреть структуру передаваемых данных (`weekly_data`, `aggregated_stats`) так, чтобы она соответствовала новой структуре шаблона `campaign_detail.html` (который теперь использует вкладки и карточки метрик). Возможно, потребуется передавать данные для каждой вкладки (среза) отдельно или изменить способ их агрегации.
    *   **Пагинация (Серверная):**
        *   Для запросов к БД, возвращающих списки площадок (`WeeklyPlacementStat`) и поисковых запросов (`WeeklySearchQueryStat`), реализовать пагинацию.
        *   Использовать метод `.paginate()` из Flask-SQLAlchemy: `WeeklyPlacementStat.query.filter(...).paginate(page=page_num, per_page=ROWS_PER_PAGE, error_out=False)`.
        *   Получить номер текущей страницы (`page_num`) из аргументов запроса (`request.args.get('page', 1, type=int)`).
        *   Передать объект пагинации (`pagination_placements`, `pagination_queries`) в шаблон. `ROWS_PER_PAGE` можно задать как константу (например, 25).
*   **Шаблон (`app/templates/reports/campaign_detail.html`):**
    *   **Вкладки (Tabs):** Убедиться, что данные для каждого среза (Площадки, Запросы, Гео и т.д.) корректно передаются и отображаются в соответствующей вкладке (`<div class="tab-content" id="tab-...">`). Проверить циклы `for` внутри каждой вкладки.
    *   **Карточки Метрик:** Передавать `aggregated_stats` (или другие необходимые данные) в шаблон и отображать их в компонентах `.metric-card`.
    *   **Таблицы:** Обновить циклы для отображения данных из объектов пагинации (например, `{% for item in pagination_placements.items %}`).
    *   **Пагинация (HTML):** Интегрировать HTML-код для отображения ссылок пагинации (предыдущая/следующая страница, номера страниц), используя данные из объекта пагинации (`pagination_placements.iter_pages()`, `pagination_placements.has_prev`, `pagination_placements.has_next`, `pagination_placements.page`, `pagination_placements.prev_num`, `pagination_placements.next_num`). Ссылки пагинации должны передавать параметр `?page=N` в URL.
    *   **JS Интеграция:** Убедиться, что JS-код для вкладок, сортировки таблиц (если она реализована в `main.js`) корректно работает с новой разметкой и данными.

**Подзадача 6.3: Проверка и Корректировка JS (`static/js/main.js`)**

*   **Действия:**
    *   Просмотреть JS-код (`main.js`).
    *   Убедиться, что селекторы (`document.querySelector`, `document.querySelectorAll`) соответствуют классам и ID в обновленных HTML-шаблонах.
    *   Проверить работу переключения вкладок, закрытия flash-сообщений, сортировки таблиц (если есть).
    *   Внести необходимые корректировки в селекторы или логику JS, если что-то не работает из-за изменений в HTML или структуре данных.

**Подзадача 6.4: Общие Проверки**

*   **Шрифты:** Убедиться, что шрифты Roboto подключены в `base.html` (если решено их использовать).
*   **Адаптивность:** Проверить базовую адаптивность нового интерфейса на разных размерах экрана.
*   **Консоль Браузера:** Проверить консоль браузера на наличие ошибок JavaScript или проблем с загрузкой ресурсов.

**Важные Замечания для Cursor:**
*   Внимательно изучи новые шаблоны (`campaign_list.html`, `campaign_detail.html`) и документацию (`UI_DOCUMENTATION.md`) для понимания ожидаемой структуры HTML и данных.
*   Сфокусируйся на **адаптации backend-логики (роутов Flask)** для передачи данных в **формате, необходимом новым шаблонам**.
*   Реализуй **серверную пагинацию** с использованием `.paginate()` для таблиц площадок и запросов.
*   Проверь и при необходимости **скорректируй селекторы в `main.js`**.
*   Используй `render_template` для передачи данных в шаблоны.

## 4. Следующий Шаг (После Шага 6) - Завершение Вехи 4 (MVP)**

*   [ ] **Реализация Функции Скачивания CSV (Подзадача 4.6 из предыдущего плана):** Создание роута и логики для генерации и скачивания CSV-файла с данными из локальной БД по выбранным пользователем срезам.

## 5. Дальнейшие Вехи (Пост-MVP)**

*   [ ] **Веха 5: Автоматизация и Действия:** Автоматический еженедельный сбор, Реализация блокировки площадок/минусации.
*   [ ] **Веха 6: Улучшения и Доп. Функции:** Динамический анализ, произвольные периоды, отчет по объявлениям, контроль бюджета, улучшения UX/UI, переход на фоновые задачи, шифрование.
*   [ ] **Веха 7: Интеграция AI.**
