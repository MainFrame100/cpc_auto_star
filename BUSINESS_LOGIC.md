**Версия:** 0.3 от 27.04.25

**1. Концепция Продукта**

*   **Продукт:** "CPC Auto Helper" - Веб-приложение (SaaS) для специалистов и агентств, работающих с Яндекс.Директ.
*   **Миссия:** Предоставить единую платформу для удобного сбора, анализа и оптимизации данных из **нескольких аккаунтов** Яндекс.Директ, экономя время специалистов, повышая прозрачность и эффективность управления рекламой, и предоставляя интеллектуальные рекомендации на основе данных.
*   **Ключевая Ценность:** Экономия времени специалистов на анализе данных, формировании отчетов и выполнении других рутинных задач.Дополнительно: помочь быстрее и точнее находить проблемы в РК и точки роста.

**2. Целевая Аудитория**

*   **Первичная:**
    *   Специалисты digital-агентств (ведут несколько клиентов/аккаунтов).
    *   Фрилансеры (ведут несколько клиентских проектов).
    *   In-house специалисты (могут вести несколько аккаунтов одного бренда или разные проекты).
*   **Вторичная:**
    *   Руководители отделов маркетинга/контекстной рекламы.

**3. Функциональные Требования**

**3.1. Управление Доступом, Клиентами и Аккаунтами (Расширено)**

*   **3.1.1. Аутентификация Пользователя Сервиса (Как сейчас):**
    *   Вход пользователя *в сам сервис* CPC Auto Helper осуществляется через Яндекс OAuth (основной аккаунт пользователя).
    *   Безопасное хранение токенов этого основного аккаунта.
*   **3.1.2. Управление "Клиентами" (Новая Сущность):**
    *   Пользователь сервиса может создавать сущности "Клиент" внутри своего аккаунта CPC Auto Helper (например, "Клиент А", "Проект Б").
    *   Для каждого "Клиента" пользователь сможет подключать один или несколько рекламных аккаунтов Яндекс.Директ.
*   **3.1.3. Подключение Аккаунтов Яндекс.Директ (Новый Механизм):**
    *   Пользователь инициирует подключение нового рекламного аккаунта Яндекса к выбранному "Клиенту" в интерфейсе CPC Auto Helper.
    *   Запускается стандартный флоу Яндекс OAuth, где пользователь авторизуется под нужным **рекламным аккаунтом** Яндекса и предоставляет доступ приложению CPC Auto Helper.
    *   Сервис безопасно сохраняет OAuth-токены (`access_token`, `refresh_token`) для **каждого подключенного рекламного аккаунта**, связывая их с соответствующим "Клиентом" и пользователем сервиса.
    *   Реализован механизм автоматического обновления токенов для всех подключенных аккаунтов.
*   **3.1.4. Управление Подключенными Аккаунтами:**
    *   Пользователь видит список своих "Клиентов".
    *   Для каждого "Клиента" пользователь видит список подключенных рекламных аккаунтов Яндекс.Директ.
    *   Возможность отключить конкретный рекламный аккаунт от "Клиента" (удаление токенов).
    *   Возможность удалить "Клиента" (с отключением всех связанных аккаунтов).

**3.2. Сбор и Хранение Статистических Данных**

*   **3.2.1. Логика Сбора Данных:**
    *   Данные собираются из API Яндекс.Директ Reports v5 для **всех активных подключенных рекламных аккаунтов**.
    *   **Гранулярность (MVP):** Данные агрегируются и хранятся **понедельно**. В будущем возможен переход на хранение данных по дням, для более гибкого анализа или анализа данных за месяц.
    *   **Историческая Глубина (MVP):** Хранение данных за последние **4 полные прошедшие недели**.
    *   **Механизм Запуска Сбора (MVP):** **Ручной запуск** пользователем из интерфейса (для выбранного "Клиента" или всех). Функция первичной загрузки и обновления за 4 недели.
    *   **Механизм Запуска Сбора (Пост-MVP):** Автоматический еженедельный фоновый сбор.
*   **3.2.2. Собираемые Показатели:** Показы, Клики, CTR(%), Расход(руб. с НДС), CPC, Отказы(%), Конверсии(∑ по указанным целям), CPA(средняя по указанным целям), CR(%). *Примечание: Глубина просмотра и Отказы требуют Метрики.*
*   **3.2.3. Собираемые Срезы:** Общий по Кампании, Площадки, Запросы, Регионы, Устройства, Пол, Возраст.
*   **3.2.4. Хранение Данных:**
    *   Данные сохраняются в реляционной БД (**PostgreSQL** - принято как стандарт, но в будущем возможно стоит перейти на что-то более специализированное).
    *   Таблицы статистики (`Weekly*Stats`) должны включать поля `user_id` (пользователь сервиса), `client_id` (сущность "Клиент") и `yandex_account_login` (логин подключенного рекламного аккаунта) для корректной фильтрации и агрегации.

**3.3. Анализ и Отображение Данных**

*   **3.3.1. Интерфейс Просмотра:**
    *   Пользователь выбирает "Клиента" для анализа.
    *   **Список Кампаний:** Отображается **агрегированный список кампаний** из *всех* рекламных аккаунтов, подключенных к данному "Клиенту". Включает Название, ID, Показы, Клики, CTR(%), Расход(руб. с НДС), CPC, Отказы(%), Конверсии(∑ по указанным целям), CPA(средняя по указанным целям), CR(%). После добавления функционала автоматического анализ РК, еще будут подсвечиваться проблемные и наоборот успешные кампанийй. Цель этого отображения: быстро показать ситуацию за прошлую неделю и кампании, требующие внимания.
    *   **Детализация Кампании:** При клике на кампанию отображается детальная статистика, собранная из того аккаунта, к которому принадлежит кампания.
    *   Отображение даты последнего обновления данных (по клиенту/аккаунту).
    *   Кнопки для ручного запуска сбора/обновления данных (по клиенту).
*   **3.3.2. Режим Анализа (MVP):** Просмотр данных за последние 4 недели (агрегированно и с детализацией по неделям) из локальной БД.
*   **3.3.3. Экспорт в CSV (MVP):**
    *   Возможность выбрать "Клиента", кампанию(и), период (4 недели) и срезы.
    *   Скачивание CSV с данными из **локальной БД**.

**3.4. Установка Целевых KPI (Новый Функционал - Пост-MVP)**

*   **3.4.1. Настройка KPI:** Пользователь сможет для каждого "Клиента" (или на уровне кампании) указывать **целевые значения KPI** на неделю:
    *   Целевое количество конверсий (лидов).
    *   Максимально допустимая стоимость конверсии (CPL/CPA).
*   **3.4.2. Использование в Анализе:** Эти KPI будут использоваться в будущем для:
    *   Визуального сравнения факта с планом в отчетах.
    *   Автоматического анализа эффективности AI-модулем.

**3.5. Действия по Оптимизации**

*   **3.5.1. Блокировка Площадок (MVP):** Будет реализовано после внедрения базового AI-анализа. Выбор площадок в интерфейсе -> Вызов API `set`.
*   **3.5.2. Добавление Минус-Слов (Отложено после AI):** Будет реализовано после внедрения базового AI-анализа, возможно, как часть рекомендаций AI. Для этого нужно будет или получать отпользователя, или формировать с помощью AI, на основе вводыных от пользователя (сайт клиента, краткая информаци по проекту и ЦА), описание ЦА и продукта, а так же что лучше добавлять в минус-слова или наоборот сохранять.

**3.6. Контроль Бюджета (Отложено после AI)**

*   Функционал контроля бюджета будет реализован после внедрения AI-анализа.
*   Логика работы функционала. Считаем средний расход в день. Умножаем его на количество дней между пополнениями (или то значение в днях, которое укажет пользователь). Сравниваем фактический баланс с этим значением. Если он меньше целевого значения, то бюджет показывается крассным. И в целом привлекаем внимание пользователя к факту, что бюджет меньше целевого.

**3.7. AI-Анализ (Дальнейшее развитие - Веха 7+)**

*   **3.7.1. Шаг 1: Общий Анализ Hi-Level:** AI анализирует **агрегированные недельные данные по всем кампаниям** клиента (сравнивая с KPI, если заданы). Цель: выявить кампании со значительным падением/ростом эффективности, проблемные (высокий CPA, низкий CR) и точки роста (хорошая эффективность, можно масштабировать). Результат: список кампаний, требующих внимания.
*   **3.7.2. Шаг 2: Глубокий Анализ по Срезам:** AI анализирует **детальные еженедельные данные по срезам** для кампаний, выявленных на Шаге 1. Цель: определить **причины** проблем или потенциал роста (например, конкретные площадки сливают бюджет, неэффективные регионы, удачные поисковые запросы). Результат: подсветить пользователю где могут быть проблемы (например, «Появилось Х площадок в РСЯ с CTR более 1,5% и расходом более 1000 руб», «Есть сильный перекос показов в регионе Y», «Стоимость конверсий сильно отличается по полу и возрасту»). AI не даёт конкретных рекомендаций что делать на текущем этапе развития проекта.
*   **3.7.3. Интеграция с Действиями:** Рекомендации AI могут быть напрямую связаны с действиями в интерфейсе (например, кнопка "Применить рекомендованные минус-слова").
*   **3.7.4. Формирование автоматических отчетов:** Рекомендации AI могут быть напрямую связаны с действиями в интерфейсе (например, кнопка "Применить рекомендованные минус-слова").

**4. Нефункциональные Требования и Ограничения**

*   **База Данных:** Используется **PostgreSQL** с самого начала разработки на боевом API.
*   **Производительность:** Особое внимание уделить производительности запросов к БД при агрегации данных от нескольких аккаунтов для списка кампаний.
*   **Безопасность:** Надежное хранение токенов для множества подключенных аккаунтов. Разграничение данных между пользователями сервиса. Важно чтобы пользователь не мог получить доступ к данным чужих рекламных кампаний, даже если он знает их ID. В целом нужно уделять особое внимние защите данных, т.к. статистика РК — это конфиденциальная коммерческая информация.
*   **Ограничения API:** Учитывать при сборе данных для множества аккаунтов и кампаний.

**5. Ключевые Вехи Реализации (Пересмотрено)**

*   **Веха 1-4: Фундамент и Базовый Просмотр (Завершено)**
*   **Веха 5: MVP в Production (Текущая - Расширенная)**
    *   **5.1:** Переход на боевое API.
    *   **5.2:** **Внедрение PostgreSQL** (включая модели для `Clients`, `YandexAccounts` и связи с `Tokens`).
    *   **5.3:** Реализация механизма подключения **нескольких рекламных аккаунтов** к "Клиенту" через OAuth.
    *   **5.4:** Адаптация сбора данных для работы с **несколькими аккаунтами** клиента.
    *   **5.5:** Реализация **агрегированного списка кампаний** (из разных аккаунтов клиента).
    *   **5.6:** Реализация сбора и отображения **конверсий** (с ручным вводом ID целей в UI - *упрощение для MVP*).
    *   **5.7:** Реализация **серверной сортировки** таблиц (Площадки).
    *   **5.8:** Реализация **блокировки площадок** (UI + API).
    *   **5.9:** Реализация **скачивания CSV**. (уже реализовано)
    *   **5.10:** Финальная очистка и тестирование MVP.
*   **Веха 6: Улучшения MVP и Автоматизация**
    *   Автоматический еженедельный сбор данных.
    *   Реализация ввода/хранения KPI.
    *   Улучшения UX (фильтры, динамический анализ, графики).
    *   Оптимизация производительности, фоновые задачи.
*   **Веха 7: Интеграция AI (Шаг 1 - Hi-Level Анализ)**
*   **Веха 8: Интеграция AI (Шаг 2 - Анализ по Срезам) + Минусация**
*   **Веха 9: Контроль Бюджета и Другие Фичи**

