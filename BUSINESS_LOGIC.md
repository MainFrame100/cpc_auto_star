**Версия:** 0.2 от 20.04.2025

**1. Концепция Продукта**

*   **Продукт:** "CPC Auto Helper" (рабочее название) - Веб-приложение (SaaS) для специалистов по контекстной рекламе Яндекс.Директ.
*   **Миссия:** Упростить и ускорить рутинные процессы анализа и оптимизации рекламных кампаний в Яндекс.Директ, предоставляя удобные инструменты для работы с данными и автоматизации повторяющихся задач.
*   **Ключевая Ценность:** Экономия времени специалиста, повышение прозрачности данных, помощь в выявлении проблем и точек роста, снижение вероятности ошибок из-за ручной обработки.

**2. Целевая Аудитория**

*   **Первичная:**
    *   Штатные специалисты по контекстной рекламе (in-house).
    *   Фрилансеры, ведущие 1-10 клиентских проектов.
    *   Специалисты digital-агентств, работающие с Яндекс.Директ.
*   **Вторичная:**
    *   Руководители отделов маркетинга/контекстной рекламы.
    *   Владельцы малого/среднего бизнеса, самостоятельно ведущие Директ (с ограничениями по сложности).

**3. Функциональные Требования (MVP и Ближайшее Развитие)**

**3.1. Управление Доступом и Аккаунтами**

*   **3.1.1. Аутентификация Пользователя (Реализовано):**
    *   Вход в систему осуществляется исключительно через Яндекс OAuth. Пользователь предоставляет доступ приложению к своему аккаунту Яндекс и API Директа.
    *   Приложение безопасно хранит OAuth-токены (`access_token`, `refresh_token`) в серверной базе данных (SQLite на этапе MVP).
    *   Реализован механизм автоматического обновления `access_token` с помощью `refresh_token` для обеспечения непрерывной работы с API.
*   **3.1.2. Управление Подключенными Аккаунтами (План):**
    *   Пользователь видит список подключенных аккаунтов Яндекс.
    *   Возможность отключить аккаунт от сервиса (удаление токенов из БД).
    *   (Пост-MVP) Возможность подключения нескольких аккаунтов Яндекс одним пользователем (например, для агентств).

**3.2. Сбор и Хранение Статистических Данных (MVP - Веха 4)**

*   **3.2.1. Логика Сбора Данных:**
    *   Данные собираются из API Яндекс.Директ (сервис Reports v5).
    *   **Гранулярность:** Данные агрегируются и хранятся **понедельно** (период: Понедельник - Воскресенье).
    *   **Историческая Глубина (MVP):** Система хранит данные за последние **4 полные прошедшие недели**.
    *   **Механизм Запуска Сбора (MVP):**
        *   **Первичная Загрузка:** Пользователь инициирует вручную через интерфейс. Система запрашивает данные за 4 последние полные недели.
        *   **Обновление Данных:** Пользователь инициирует вручную. Система перезапрашивает и перезаписывает данные за 4 последние полные недели (для учета корректировок Яндекса и оффлайн-конверсий).
    *   **Механизм Запуска Сбора (Пост-MVP):** Автоматический еженедельный запуск фоновой задачи (например, каждый понедельник) для сбора данных за предыдущую неделю.
*   **3.2.2. Собираемые Показатели (для каждой недели):**
    *   Показы (`Impressions`)
    *   Клики (`Clicks`)
    *   CTR (%) (Рассчитывается: `Clicks / Impressions * 100`)
    *   Расход (руб. с НДС) (`Cost`) - *Уточнить получение с НДС через API*
    *   Средняя цена клика (CPC) (Рассчитывается: `Cost / Clicks`)
    *   Отказы (%) (`BounceRate`) - *Требует наличия счетчика Метрики*
    *   Конверсии (∑ по всем целям) (`Conversions`) - *Требует наличия счетчика Метрики и настроенных целей*
    *   Цена цели (CPA, средняя по всем целям) (Рассчитывается: `Cost / Conversions`)
    *   Коэффициент конверсии (%) (CR) (Рассчитывается: `Conversions / Clicks * 100`)
    *   *Глубина просмотра:* (Отложено/Требует исследования доступности в API Reports).
*   **3.2.3. Собираемые Срезы (для каждой недели):**
    *   **Общий по Кампании:** Агрегированные показатели (п. 3.2.2) для каждой РК.
    *   **По Площадкам (РСЯ):** Статистика по каждой площадке (`Placement`). Показатели из п. 3.2.2 (где применимо). *Хранить Тип площадки (`AdNetworkType`) и Название (`Placement`)*.
    *   **По Поисковым Запросам (Поиск):** Статистика по каждому поисковому запросу (`Query`). Показатели из п. 3.2.2.
    *   **По Регионам Таргетинга:** Статистика по ID региона (`LocationOfPresenceId` / `LocationOfPresenceName`). Показатели из п. 3.2.2.
    *   **По Типу Устройства:** Статистика по типу устройства (`Device`). Показатели из п. 3.2.2.
    *   **По Полу:** Статистика по полу (`Gender`). Показатели из п. 3.2.2.
    *   **По Возрасту:** Статистика по возрастной группе (`Age`). Показатели из п. 3.2.2.
    *   **(Пост-MVP) По Категории Таргетинга:** Для РСЯ - статистика по интересам/условиям ретаргетинга (`AudienceTarget`).
    *   **(Пост-MVP) Срезы для Товарных Кампаний:** Статистика по товарам/категориям (`Product*`).
*   **3.2.4. Хранение Данных:**
    *   Данные сохраняются в локальной БД SQLite (на этапе MVP).
    *   Проектируются таблицы для хранения еженедельной статистики по кампаниям и каждому срезу (например, `WeeklyCampaignStats`, `WeeklyPlacementStats`, `WeeklySearchQueryStats` и т.д.) с ключом по `week_start_date`, `campaign_id` и ID среза.

**3.3. Анализ и Отображение Данных (MVP - Веха 4)**

*   **3.3.1. Интерфейс Просмотра:**
    *   Страница со списком доступных рекламных кампаний пользователя.
    *   Страница детализации выбранной кампании.
    *   Отображение даты последнего обновления данных.
    *   Кнопки для ручного запуска первичной загрузки / обновления данных за 4 недели.
*   **3.3.2. Режим Анализа (MVP):**
    *   **"Последние 4 недели"**: Пользователь выбирает кампанию. На странице детализации отображаются:
        *   Агрегированные показатели за последние 4 недели (сумма или среднее).
        *   Таблицы со статистикой по основным срезам (Площадки, Запросы, Регионы, Устройства, Пол, Возраст), агрегированные за 4 недели.
        *   (Желательно) Возможность переключиться на просмотр данных по конкретной неделе из последних четырех.
*   **3.3.3. Режим Анализа (Пост-MVP):**
    *   **"Динамика по неделям"**: Отображение ключевых показателей кампании в виде таблицы или графика за последние 4 недели.
    *   **"Произвольный Период"**: Возможность выбрать даты начала и конца для просмотра агрегированных данных (потребует агрегации еженедельных данных из БД).
*   **3.3.4. Экспорт в CSV (MVP - Веха 4):**
    *   На странице детализации кампании пользователь может выбрать один или несколько доступных срезов (Площадки, Запросы, Регионы и т.д.).
    *   Пользователь выбирает период (например, "Последние 4 недели").
    *   При нажатии кнопки "Скачать CSV" система:
        *   Запрашивает соответствующие данные из **локальной БД**.
        *   Формирует CSV-файл "на лету" в памяти.
        *   Отдает файл пользователю для скачивания с информативным именем.
        *   Файл на сервере **не сохраняется**.

**3.4. Действия по Оптимизации (Отложено после MVP)**

*   **3.4.1. Блокировка Площадок:**
    *   В таблице отчета по площадкам пользователь выбирает чекбоксами нежелательные площадки.
    *   Нажатие кнопки "Заблокировать" инициирует вызов API Директа (метод `set` для `Campaigns` или `AdGroups`) для добавления выбранных площадок в `ExcludedSites` / `ExcludedPlacements`.
    *   Пользователь получает обратную связь об успехе/ошибке через `flash`-сообщения.
*   **3.4.2. Добавление Минус-Слов:**
    *   В таблице отчета по поисковым запросам пользователь выбирает чекбоксами нерелевантные запросы.
    *   Нажатие кнопки "В минус-слова" инициирует вызов API Директа (метод `set` для `Campaigns` или `AdGroups`) для добавления выбранных запросов (в правильном формате) в `NegativeKeywords`.
    *   Пользователь получает обратную связь.

**3.5. Контроль Бюджета (План на Пост-MVP)**

*   Ручной запуск проверки бюджета по кнопке в интерфейсе.
*   Расчет норматива на 10 дней на основе расхода за последние 7 дней (из сохраненных данных).
*   Сравнение с текущим остатком бюджета (полученным по API).
*   Визуальная подсветка (красным) бюджетов, остаток которых меньше норматива.

**4. Нефункциональные Требования и Ограничения**

*   **Производительность (MVP):** Приложение должно обеспечивать приемлемое время отклика при просмотре данных и генерации CSV для умеренного количества кампаний и данных (десятки кампаний, данные за 4 недели).
*   **Надежность (MVP):** Механизм ручного обновления данных должен быть устойчив к ошибкам API. Логирование процесса сбора данных.
*   **Безопасность:** Безопасное хранение токенов (шифрование - Пост-MVP), защита от базовых веб-уязвимостей.
*   **Масштабируемость (Пост-MVP):** Переход на PostgreSQL, использование очередей задач (Celery/RQ) для фонового сбора данных и, возможно, для генерации больших CSV.
*   **Учет Ограничений API:** Соблюдение лимитов Яндекс.Директ API (запросы в секунду, отчеты в очереди). Таймауты и повторные попытки при работе с API Reports.

**5. Ключевые Вехи Реализации (Скорректировано)**

*   **Веха 1-3: Фундамент, Первый Отчет, Утилита Тестирования (Завершено)**
*   **Веха 4: MVP - Еженедельный Сбор и Анализ Данных (Текущая)**
    *   Проектирование и создание БД для еженедельных данных.
    *   Реализация ручного запуска сбора/обновления данных за 4 недели.
    *   Реализация интерфейса просмотра еженедельных данных (агрегированных и по срезам) за последние 4 недели.
    *   Реализация функции скачивания CSV по выбранным срезам из локальной БД.
*   **Веха 5: Автоматизация и Действия (Следующая после Вехи 4)**
    *   Реализация автоматического еженедельного сбора данных.
    *   Реализация функций блокировки площадок и добавления минус-слов (UI + API).
*   **Веха 6: Улучшения и Доп. Функции (Пост-MVP)**
    *   Динамический анализ, произвольные периоды, отчет по объявлениям, контроль бюджета.
    *   Улучшение UX/UI, переход на фоновые задачи, шифрование.
*   **Веха 7: Интеграция AI (Дальнейшее развитие)**

